<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Resumen de Caja Diaria</title>
  <link rel="stylesheet" th:href="@{/css/caja.css}">
</head>
<body>
<div class="page">
  <div class="card">

    <div class="header">
      <h1>Resumen de Caja Diaria</h1>
      <div class="header-actions">
        <a class="btn-secondary" th:href="@{/}">Volver a Home</a>
      </div>
    </div>

    <!-- SIN CAJA ABIERTA -->
    <div th:if="${caja == null}">
      <div class="empty-state">
        <p>No hay caja abierta.</p>
        <form th:action="@{/caja/abrir}" method="post">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button type="submit" class="btn-primary">Abrir nueva caja</button>
        </form>
      </div>
    </div>

    <!-- CON CAJA ABIERTA -->
    <div th:if="${caja != null}">
      <!-- Resumen -->
      <div class="summary-grid">
        <div>
          <div class="label">ID</div>
          <div class="value" th:text="${caja.idCaja}">—</div>
        </div>
        <div>
          <div class="label">Usuario responsable</div>
          <div class="value" th:text="${caja.usuario.nombre}">—</div>
        </div>
        <div>
          <div class="label">Fecha de apertura</div>
          <div class="value" th:text="${#temporals.format(caja.fechaApertura,'dd/MM/yyyy HH:mm')}">—</div>
        </div>
        <div>
          <div class="label">Estado</div>
          <div class="chip" th:text="${caja.estado}">abierta</div>
        </div>
        <div>
          <div class="label">Saldo inicial</div>
          <div class="value mono" th:text="${#numbers.formatDecimal(caja.saldoInicial, 1, 'POINT', 2, 'POINT')}">0,00</div>
        </div>
        <div>
          <div class="label">Saldo actual</div>
          <div class="value mono strong"
               th:text="${#numbers.formatDecimal(saldoActual, 1, 'POINT', 2, 'POINT')}">0,00</div>
        </div>
        <div>
          <div class="label">Total ingresos</div>
          <div class="value mono green"
               th:text="${#numbers.formatDecimal(totalIngresos, 1, 'POINT', 2, 'POINT')}">0,00</div>
        </div>
        <div>
          <div class="label">Total egresos</div>
          <div class="value mono red"
               th:text="${#numbers.formatDecimal(totalEgresos, 1, 'POINT', 2, 'POINT')}">0,00</div>
        </div>
      </div>

      <!-- Acciones -->
      <div class="actions">
        <form th:action="@{/caja/cerrar}" method="post" th:if="${caja.estado.name() == 'abierta'}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button type="submit" class="btn-danger">Cerrar Caja</button>
        </form>
      </div>

      <h2 class="section-title">Movimientos</h2>

      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th style="width: 170px;">Fecha/Hora</th>
            <th style="width: 190px;">Concepto</th>
            <th style="width: 120px;">Tipo</th>
            <th style="width: 140px;" class="right">Monto</th>
            <th>Usuario (quien registró)</th>
            <th>Descripción</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="m : ${movimientos}">
            <td th:text="${#temporals.format(m.fechaMovimiento,'dd/MM/yyyy HH:mm')}">14/08/2025 18:48</td>
            <td th:text="${m.concepto}">MODIFICACION_VENTA</td>
            <td>
              <span class="badge"
                    th:classappend="${m.tipo.name() == 'ingreso'} ? ' badge-ingreso' : ' badge-egreso'"
                    th:text="${m.tipo}">ingreso</span>
            </td>
            <td class="right mono"
                th:text="${#numbers.formatDecimal(m.monto, 1, 'POINT', 2, 'POINT')}">0,00</td>
            <td>
              <span th:text="${m.usuario != null ? m.usuario.nombre : '—'}">—</span>
              <small class="muted" th:if="${m.usuario != null && m.usuario.rol != null}"
                     th:text="'(' + ${m.usuario.rol} + ')'">(admin)</small>
            </td>
            <td th:text="${m.descripcion}">—</td>
          </tr>
          <tr th:if="${#lists.isEmpty(movimientos)}">
            <td colspan="6" class="empty">Sin movimientos.</td>
          </tr>
          </tbody>
          <tfoot>
          <tr>
            <td colspan="3" class="right strong">Totales</td>
            <td class="right mono">
              <span class="green" th:text="'+' + #numbers.formatDecimal(totalIngresos, 1, 'POINT', 2, 'POINT')">+0,00</span>
              &nbsp;/&nbsp;
              <span class="red" th:text="'-' + #numbers.formatDecimal(totalEgresos, 1, 'POINT', 2, 'POINT')">-0,00</span>
            </td>
            <td colspan="2"></td>
          </tr>
          </tfoot>
        </table>
      </div>

      <div class="footer-actions">
        <a class="btn-secondary" th:href="@{/}">Volver a Home</a>
      </div>
    </div>

  </div>
</div>
</body>
</html>